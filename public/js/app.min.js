"use strict";var socket=io.connect("http://127.0.0.1:3333/"),app=app||{},Scorn=Scorn||{};!function(ns){function _lightboxer(lightbox){$(".comment a[href]").on("click",function(e){var path=$(this).attr("href"),extension=path.split(".").pop();IMAGES.indexOf(extension)>-1&&lightbox&&(e.preventDefault(),ns.lightboxContent.html('<img src="'+path+'" />'),ns.lightboxContent.parents(".fade").modal("toggle"))})}function _toggleLinks(newWindow,scope){var links=scope?scope.find(linkSelector):$(linkSelector);newWindow?links.attr("target","_blank"):links.attr("target","_self")}function _persister(persist){function _updateHandle(){ns.options.handle=ns.postForm.handle.val(),Scorn.Cookie.createCookie("scorn-options",JSON.stringify(ns.options))}persist?(ns.postForm.handle.on("change",function(){_updateHandle()}),_updateHandle()):(Scorn.Cookie.createCookie("scorn-options","{}"),ns.postForm.handle.unbind("change"))}function _buildComment(){return new Scorn.Comment(ns.postForm.handle.val(),ns.postForm.comment.val())}function quoteFactory(post){return function(){ns.postForm.comment.focus().val(function(){return[post.comment.replace(/^/gm,"> "),"> ","> "+post.handle+" | "+post.formattedTime(),"",""].join("\n")})}}function printPost(post){var content=$template.clone(),comment=new Scorn.Comment(post.handle,post.comment,post.homepage,post.timestamp),contentComment=content.find(".comment");contentComment.html(comment.printComment()),contentComment.find("a").text(function(i,text){return text.length>30?text.substr(0,30)+"...":text}),content.find(".handle").text(comment.handle).on("click",function(){ns.postForm.comment.text(ns.postForm.comment.text()+"@"+comment.handle+" ")}),content.find(".timestamp").text(comment.formattedTime()),content.find(".quote").on("click",quoteFactory(comment,ns.postForm.comment)),ns.target.append(content),_lightboxer(ns.options.lightbox),_toggleLinks(ns.options.newWindow,content)}function showMore(show){show?(more.fadeIn(),window.onscroll=function(){showMore(!1),window.onscroll=void 0}):more.fadeOut()}function _setUpSocketEvents(){socket.on("blast",function(post){printPost(post),showMore(!0)}),socket.on("posts",function(posts){ns.target.html(""),$.each(posts,function(stupid,post){printPost(post)})}),socket.on("readerCount",function(data){ns.readerCount.text(data.count)}),ns.postForm.submit.on("click",function(e){e.preventDefault();var post=_buildComment();post.comment.length&&post.handle.length&&socket.emit("post",post,function(){ns.postForm.comment.val("")})})}function _optionHandlerFactory(el){return function(){var $input=el;switch($input.attr("id")){case"pop":ns.options.newWindow=ns.optionInputs.newWindow.is(":checked")?!0:!1,_toggleLinks(ns.options.newWindow);break;case"lightbox":ns.options.lightbox=ns.optionInputs.lightbox.is(":checked")?!0:!1,_lightboxer(ns.options.lightbox)}ns.options.persist=ns.optionInputs.persist.is(":checked")?!0:!1,_persister(ns.options.persist)}}var $template=$('<div class="post"><div class="comment"></div><div class="meta"><span class="handle"></span> | <span class="timestamp"></span> | <a href="#form" class="quote">Quote</a></div></div>'),IMAGES=["jpg","jpeg","png","gif","svg","bmp"],linkSelector=".comment a[href]",more=$("#more");ns.init=function(){var cookieOptions=JSON.parse(Scorn.Cookie.readCookie("scorn-options"))||{};ns.optionInputs={lightbox:$("#lightbox"),newWindow:$("#pop"),persist:$("#remember")},ns.postForm={handle:$("#handle"),comment:$("#comment"),submit:$("#send")},ns.target=$("#allPosts"),ns.readerCount=$("#readerCount"),ns.lightboxContent=$("#lightbox-modal .modal-content"),ns.options={lightbox:!!cookieOptions.lightbox,newWindow:!!cookieOptions.newWindow,persist:!!cookieOptions.persist,handle:cookieOptions.handle||""},ns.optionInputs.lightbox.attr("checked",ns.options.lightbox),ns.optionInputs.newWindow.attr("checked",ns.options.newWindow),ns.optionInputs.persist.attr("checked",ns.options.persist),ns.postForm.handle.val(ns.options.handle),_lightboxer(ns.options.lightbox),_toggleLinks(ns.options.newWindow),_setUpSocketEvents();for(var key in ns.optionInputs)ns.optionInputs[key].on("change",_optionHandlerFactory(ns.optionInputs[key]));window.onbeforeunload=function(){socket.onclose=function(){},socket.close()},$("#bottom").click(function(){return $("html, body").animate({scrollTop:$(document).height()},"slow"),!1})}}(Scorn),$(function(){Scorn.init()});var Scorn=Scorn||{};!function(ns){function linkify(string){return string}ns.Comment=function(handle,comment,homepage,timestamp){this.handle=handle,this.comment=comment,this.homepage=homepage||null,this.timestamp=timestamp||Date.now()},ns.Comment.prototype.printComment=function(){if(this.comment){var formatted=linkify(marked(this.comment));return formatted}return this.comment},ns.Comment.prototype.formattedTime=function(){return moment(this.timestamp).format("M.D.YYYY - HH:mm:ssa")}}(Scorn),function(ns){ns.Cookie={},ns.Cookie.createCookie=function(name,value,days){var expires;if(days){var date=new Date;date.setTime(date.getTime()+24*days*60*60*1e3),expires="; expires="+date.toGMTString()}else expires="";document.cookie=name+"="+value+expires+"; path=/"},ns.Cookie.readCookie=function(name){for(var nameEQ=name+"=",ca=document.cookie.split(";"),i=0;i<ca.length;i++){for(var c=ca[i];" "===c.charAt(0);)c=c.substring(1,c.length);if(0===c.indexOf(nameEQ))return c.substring(nameEQ.length,c.length)}return null}}(Scorn);